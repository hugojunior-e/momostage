<html>

<head>
	<title>Algar ETL</title>
	<link rel="StyleSheet" href="/static/styles/style.css" type="text/css">
	<script type="text/javascript" src="/static/js/functions.js"></script>
	<script type="text/javascript" src="/static/js/tree.js"></script>

	<script type="text/javascript">
		function jsShowPidDetail(pid) {
			const elementos = document.querySelectorAll('[id^="pid' + pid + '"]');
			elementos.forEach(el => {
				el.style.display = el.style.display == 'none' ? '' : 'none';
			});
		}

		function jsCheckAbort(x) {
			ajax("/info", { "name": "check_abort", "batch_id":x, "sql_pars": [] }, function (a) {
				alert( a.message );
				ttr = Array.from(id_table_proc.querySelectorAll('a')).filter( eel => eel.innerText.trim() === ("" + x) ) [0];
				ttr.parentNode.parentNode.remove();
				//window.location.reload();
			}, null);

		}

		function list_process_running() {

			ajax("/info", { "name": "dashboard_index", "sql_pars": [] }, function (a) {
				document.all.id_memory.innerHTML = a.memory.message;
				document.all.id_memory.querySelectorAll("table")[0].className = 'table_detail';

				document.all.id_process_running.innerHTML = a.process_running.message;
				document.all.id_process_running.querySelectorAll("table")[0].className = 'table_detail';


				document.all.id_process_aborted.innerHTML = a.process_aborted.message;
				document.getElementById('id_table_proc').className = 'table_detail';
				document.getElementById('id_table_proc').querySelectorAll("tr").forEach( (row, index) => {
					if ( index > 0 ) {
						if (row.cells[4].innerHTML != "ALGARSCHEDULER") {
							row.cells[1].innerHTML = '<a href="/designer?job_name=' + row.cells[1].innerHTML + '" target=__blank>' + row.cells[1].innerHTML + '</a>';
						}

						row.cells[6].innerHTML = "-";
						if (row.cells[0].innerHTML == "A") {
							row.cells[6].innerHTML = '<a href=# onclick=jsCheckAbort(' + row.cells[2].innerHTML + ')>check</a>';
						}

						row.cells[2].innerHTML = '<a href=/logger?batch_id=' + row.cells[2].innerHTML + ' target=LOGG>' + row.cells[2].innerHTML + '</a>';
						if (row.cells[0].innerHTML == "F") row.cells[0].innerHTML = "ðŸŸ¢";
						if (row.cells[0].innerHTML == "A") row.cells[0].innerHTML = "ðŸŸ¥";
						if (row.cells[0].innerHTML == "E") row.cells[0].innerHTML = "ðŸ”·";
						if (row.cells[0].innerHTML == "K") row.cells[0].innerHTML = "âŒ";

					}
				});				

			}, null);
		}


		function jsClearAppTemp() {
			alert("em construÃ§Ã£o");
		}


		function jsKillProcess(pid) {
			if (confirm("Are you sure you want to kill the process " + pid + "?")) {
				ajax("/info", { "name": "kill_process", "pid": pid }, function (a) {
					alert(a.message);
				}, null);
			}

		}

		function list_tree_view() {
				ajax("/info", { "name": "list_treeview" }, function (a) {
					ret = window.treeview.montaArvoreDados(a.message);
					id_treeview.innerHTML = ret;

				}, null);
		}

		function js_open_job(x) {
			aa = x.split("...")
			window.open("/designer?job_name=" + aa[ aa.length - 2 ]);
		}

		function jsFindJob(jb) {
		  id = document.getElementById('id_no_' + jb.toLowerCase() + '...' );
		  x  = id.parentNode;

		  while (x.id != 'id_treeview' ) {
			oc( x.id.substring(3) , 1 )
			x = x.parentNode;
		  }

		  id_job_find.style.display = 'none';
		}

		function jsFindJobList() {
			ajax("/info", { "name": "tablemodel", "sql": "job_find_all_jobs", "sql_pars": [ id_job_find_name.value ] }, function (a) {
				id_job_find_list.innerHTML = a.message;

				id_job_find_list.querySelectorAll("tr").forEach((e, idx) => {
					if (idx > 0) {
						e.cells[0].value      = e.cells[0].innerHTML;
						e.cells[0].innerHTML  = "<a href=# onclick=js_open_job('" + e.cells[0].innerHTML + "...') >" + e.cells[0].innerHTML + "</a>";
					}
				});

			}, null);
		}
	</SCRIPT>
</head>

<body>
	<div class="menu">
		<button onclick="window.location.reload()">Reload Repository</button> &nbsp;
		<button onclick="window.open('/designer?job_name=newjob')">Create new Job</button> &nbsp;
		<button onclick="window.open('/globals')">Parameters Globals</button> &nbsp;
		<button onclick="window.open('/sequences')">Sequences</button> &nbsp;
		<button onclick="window.open('/monitor')">Dashboard Process</button> &nbsp;

		<div id="id_title_page" class="titles_toolbar" style="cursor: pointer" onclick="window.open('/logout')">Logout:
			{{ login }}</div>
	</div>


	<div class="container">
		<div class="div-esquerda">
			<div class="sidebar" id="id_treeview"></div>
			<center><a href="#" onclick="id_job_find.style.display = 'block'"> Find Job </a></center>
		</div>

		<div class="div-direita">
			<div class="area">
				<span class="titulo">Memory|Disk|CPU|IO Monitor </span>
				<div class="div_pre" id="id_memory"></div>
				<br>
		
				<span class="titulo">Process Running Now (SO)</span>
				<div class="div_pre" id="id_process_running"></div>
				<br>

				<span class="titulo">Monitor Process (Timeled) </span> <!-- ðŸŸ¢ - OK | ðŸŸ¥ - ABORTED | ðŸ”· - IN EXECUTION | âŒ - FINISHED WITH WARNINGS -->
				<div class="div_pre" id="id_process_aborted"></div>
			</div>

		</div>

	</div>


    <div id="id_job_find" class="itools_modal">
        <div class="itools_modal_content">
			<span class="itools_modal_close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
			<h2>Job Find</h2>
			<input type=text id=id_job_find_name oninput=jsFindJobList()>
			<hr>
			<div class="div_pre" id="id_job_find_list"></div>
        </div>
    </div>


	<script>
		window.treeview = new TreeView();
		window.treeview.endNodeClick = "js_open_job";
		window.treeview.endNodeParamClick = "nodeValues[3]";

		list_process_running();
		list_tree_view();
		setInterval(list_process_running, 30000);
	</script>
</body>

</html>
